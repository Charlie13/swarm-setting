---
title: "맞춤형 의학연구 애플리케이션을 위한 개발 환경 구축"
author: "Jinseob Kim"
date: "October 26, 2018"
output:
  slidy_presentation:
    theme: readable
    highlight: tango
    font_adjustment: +2
    duration: 40
    footer: "&copy;2018 ANPANMAN Co.,Ltd. All rights reserved."
    fig_width: 7
    fig_height: 6
    fig_caption: true
    df_print: paged

---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, fig.align = "center")
library(data.table);library(DT);library(knitr)
```



# Executive Summary 


맞춤형 의학연구 애플리케이션을 위해


1. `Rstudio`와 `shiny server`가 설치된 [Docker](https://www.docker.com/what-docker) 이미지를 만들고 이것을 [Docker swarm](https://docs.docker.com/engine/swarm/)을 이용해 배포함으로써 서버의 종류와 갯수에 구애받지 않는  **마이크로서비스 아키텍처**(microservice architecture)를 구축하였으며


2. 동적 프록시 서버(dynamic proxy server) 프로그램인 [Traefik](https://traefik.io/) 을 이용하여  서비스가 추가될 때 마다(ex: 홈페이지, Jupyter) 이에 맞추어 **https** 보안이 적용된 **subdomain 주소**를 부여하였습니다.


3. 흔히 이용되는 의학통계 방법들을 `ShinyApps` 로 만들어 위의 환경에 배포하였으며, 모든 앱에는 논문/보고서용 테이블과 그림을 위해 **데이터 라벨(label) 정보**를 적용하였습니다.

```{r, out.width= "50%"}
include_graphics("color_logo_transparent.png")
```


# 1. 마이크로서비스 아키텍처 

```{r, out.width= "40%"}
include_graphics("https://blog.philipphauer.de/blog/2015/0411-microservices-nutshell-pros-cons/Monolith-vs-Microservices.png")
```

```{r, out.width= "60%"}
include_graphics("https://blog.philipphauer.de/blog/2015/0411-microservices-nutshell-pros-cons/Scaling-Microservices.png")
```

https://blog.philipphauer.de/microservices-nutshell-pros-cons/




# [Docker](https://www.docker.com/what-docker)

- 빠르고 용량이 적은 가상머신?
- [Docker hub](https://hub.docker.com/)을 통해 [github](https://github.com/)처럼 이용가능.  
- 서버에 rstudio 설치(X), 서버에  rstudio가 설치된 리눅스 이미지를 설치(O). 

```{r, out.width= "50%"}
include_graphics("https://subicura.com/assets/article_images/2017-01-19-docker-guide-for-beginners-1/vm-vs-docker.png")
```

https://subicura.com/2017/01/19/docker-guide-for-beginners-1.html


# [Docker-machine](https://docs.docker.com/machine/overview/)

- 여러 대의 서버(docker가 설치된)를 한 번에 관리할 수 있음. 
- 예) AWS 서버 2대 불러오기, 서버 삭제하기

```shell
base=https://github.com/docker/machine/releases/download/v0.15.0 &&
curl -L $base/docker-machine-$(uname -s)-$(uname -m) >/tmp/docker-machine &&
sudo install /tmp/docker-machine /usr/local/bin/docker-machine
docker-machine version
```


# 예: Digital ocean - manager 이름으로 서버 생성.   

```shell
export DIGITALOCEAN_ACCESS_TOKEN=<YOUR_DIGITALOCEAN_ACCESS_TOKEN>
export DIGITALOCEAN_IMAGE="ubuntu-18-04-x64"
export DIGITALOCEAN_REGION="sgp1"
echo "### Creating manager nodes ..."

for c in {1..1} ; do
  docker-machine create \
     --driver digitalocean \
     --digitalocean-access-token $DIGITALOCEAN_ACCESS_TOKEN \
     --digitalocean-image $DIGITALOCEAN_IMAGE \
     --digitalocean-region $DIGITALOCEAN_REGION \
     --digitalocean-size "s-2vcpu-4gb" \
     manager$c &&\
  docker-machine ssh manager$c "adduser js --gecos 'First Last,RoomNumber,WorkPhone,HomePhone' --disabled-password && sh -c 'echo js:js | sudo chpasswd' && usermod -aG sudo js"
done
```


# AWS

```shell
export AWS_ACCESS_KEY_ID=<YOUR_AWS_ACEESS_KEY_ID>
export AWS_SECRET_ACCESS_KEY=<YOUR_AWS_SECRET_ACCESS_KEY>
export AWS_INSTANCE_TYPE="t2.micro" 
export AWS_INSTANCE_REGION="ap-northeast-2"
export AWS_SECURITY_GROUP="launch-wizard-2"
export AWS_VPC_ID=<YOUR_AWS_VPC_ID>
export AWS_ZONE=c


for c in {1..1} ; do
docker-machine create \
  --driver amazonec2 \
  --amazonec2-access-key $AWS_ACCESS_KEY_ID \
  --amazonec2-secret-key $AWS_SECRET_ACCESS_KEY \
  --amazonec2-region $AWS_INSTANCE_REGION \
  --amazonec2-vpc-id $AWS_VPC_ID \
  --amazonec2-open-port 3838 \
  --amazonec2-open-port 8787 \
  --amazonec2-open-port 8000 \
  --amazonec2-open-port 8080 \
  --amazonec2-open-port 2377 \
  --amazonec2-open-port 7946 \
  --amazonec2-open-port 7946/udp \
  --amazonec2-open-port 4789 \
  --amazonec2-open-port 4789/udp \
  --amazonec2-open-port 8888 \
  --amazonec2-open-port 80 \
  --amazonec2-open-port 443 \
  manager$c && \
  docker-machine ssh manager$c "adduser js --gecos 'First Last,RoomNumber,WorkPhone,HomePhone' --disabled-password && sh -c 'echo js:js | sudo chpasswd' && usermod -aG sudo js"
done
```

# AZURE

```shell
export sub=<YOUR_AZURE_SUBSCRIPTION_VALUE>

for c in {1..1} ; do
docker-machine create \
    --driver azure \
    --azure-location "koreacentral" \
    --azure-size Standard_B1s \
    --azure-subscription-id $sub \
    --azure-open-port 3838 \
    --azure-open-port 8787 \
    --azure-open-port 8000 \
    --azure-open-port 8080 \
    --azure-open-port 2377 \
    --azure-open-port 7946 \
    --azure-open-port 7946/udp \
    --azure-open-port 4789 \
    --azure-open-port 4789/udp \
    --azure-open-port 8888 \
    --azure-open-port 80 \
    --azure-open-port 443 \
    manager$c && \
    docker-machine ssh manager$c "adduser js --gecos 'First Last,RoomNumber,WorkPhone,HomePhone' --disabled-password && sh -c 'echo js:js | sudo chpasswd' && usermod -aG sudo js"
done
```





# [Docker swarm](https://docs.docker.com/engine/swarm/) 

- Server orchestration: 지휘자가 오케스트라 연주하듯이
- 여러대의 서버를 묶어 마치 하나의 서버를 이용하는 것처럼 느낌. 
- 자동으로 한가한 서버부터 서비스 배치. 

```{r, out.width= "50%"}
include_graphics("https://www.upcloud.com/support/wp-content/uploads/2016/10/Docker-Swarm-Orchestration-1024x265.png")
```

https://www.upcloud.com/support/docker-swarm-orchestration/


# 묶을 서버 추가오기 : Worker node 

```shell
export DIGITALOCEAN_SIZE="s-1vcpu-1gb"
echo "### Creating worker nodes ..."
for c in {1..1} ; do
    docker-machine create \
  --driver digitalocean \
  --digitalocean-access-token $DIGITALOCEAN_ACCESS_TOKEN \
  --digitalocean-image $DIGITALOCEAN_IMAGE \
  --digitalocean-region $DIGITALOCEAN_REGION \
  --digitalocean-size $DIGITALOCEAN_SIZE \
  worker$c && \
  docker-machine ssh worker$c "adduser js --gecos 'First Last,RoomNumber,WorkPhone,HomePhone' --disabled-password && sh -c 'echo js:js | sudo chpasswd' && usermod -aG sudo js"
done
```


# 서버 묶기 

**manager1** 과 **worker1** 노드를 [docker swarm](https://docs.docker.com/engine/swarm/)를 활용하여 묶자. 

```shell
# Get IP from leader node
leader_ip=$(docker-machine ip manager1)

# Init Docker Swarm mode
echo "### Initializing Swarm mode ..."
eval $(docker-machine env manager1)
docker swarm init --advertise-addr $leader_ip

# Swarm tokens
manager_token=$(docker swarm join-token manager -q)
worker_token=$(docker swarm join-token worker -q)

# Joinig manager nodes
echo "### Joining manager modes ..."
for c in {1..1} ; do
    eval $(docker-machine env manager$c)
    docker swarm join --token $manager_token $leader_ip:2377
done

# Join worker nodes
echo "### Joining worker modes ..."
for c in {1..1} ; do
    eval $(docker-machine env worker$c)
    docker swarm join --token $worker_token $leader_ip:2377
done


# Clean Docker client environment
echo "### Cleaning Docker client environment ..."
eval $(docker-machine env -u)
```


# 서비스 실행: rstudio & shiny server

자체적으로 이미지 [docker-rshiny](https://hub.docker.com/r/jinseob2kim/docker-rshiny/) 를 만들어 사용하였다.

```shell
docker service create \
    --name rshiny \
    --publish 8787:8787 \
    --publish 3838:3838 \ 
    -e USER=js -e PASSWORD=js -e ROOT=TRUE \
    --mount=type=bind,src=/home/js,dst=/home/rstudio \
    --network traefik-net \
     jinseob2kim/docker-rshiny
```
**8787** 포트에서 'rstudio server'를, **3838** 포트에서 'shiny server'를 실행할 수 있다. 



# 2. Dynamic proxy & https: [Traefik](https://traefik.io/)

- www.anpanman.co.kr:3838, :8787 보기 싫다.  
- rstudio.anpanman.co.kr, shiny.anpanman.co.kr 같이 **subdomain**으로 만들고 싶다. 
- tensorflow 추가하면 tensorflow.anpanman.co.kr,  서비스 추가할 때마다 서비스명.anpanman.co.kr로 만들고 싶다. 
- 무료 https 인증 프로그램인 [Let's Encrypt](https://letsencrypt.org/) 를 자동으로 적용하고 싶다. 

```{r, out.width= "50%"}
include_graphics("https://boxboat.com/wp-content/uploads/2017/10/Managing-Multiple-Microservices-with-Traefik-in-Docker-Swarm-2-1080x675.png")
```

https://boxboat.com/2017/10/10/managing-multiple-microservices-with-traefik-in-docker-swarm/


# Run [Traefik](https://traefik.io/)

```shell
eval $(docker-machine env manager1)
DOMAINNAME="anpanman.co.kr"

# Create network for swarm
docker network create --driver=overlay traefik-net

# For Let's Encrypt
docker-machine ssh manager1 "DOMAINNAME=anpanman.co.kr && \ 
                             mkdir /home/js/opt && \ 
                             mkdir /home/js/opt/traefik && \
                             cd /home/js/opt/traefik && \
                             touch acme.json && chmod 600 acme.json && \
                             wget -O traefik.toml  https://raw.githubusercontent.com/jinseob2kim/swarm-setting/master/opt/traefik/traefik.toml"
                             
                             
# Create traefik service
docker service create \
    --name traefik \
    --constraint=node.role==manager \
    --publish 80:80 --publish 443:443\
    --mount type=bind,source=/var/run/docker.sock,target=/var/run/docker.sock \
    --mount type=bind,source=/root/acme.json,target=/acme.json \
    --mount type=bind,source=/root/traefik.toml,target=/traefik.toml \
    -e DO_AUTH_TOKEN=$DIGITALOCEAN_ACCESS_TOKEN \
    -l traefik.port=8080 \
    -l traefik.frontend.rule=Host:monitor.$DOMAINNAME\
    --network traefik-net \
    traefik \
    --logLevel=INFO \
    --docker \
    --docker.swarmMode \
    --docker.watch \
    --docker.domain=$DOMAINNAME
```

https://monitor.anpanman.co.kr 에서 dashboard를 볼 수 있다.



# 서비스 재실행: rstudio & shiny server

[Traefik](https://traefik.io/) 를 적용하여 재실행하자. 

```shell
docker service create \
    --name rshiny \
    --label traefik.shiny.port=3838 \
    --label traefik.rstudio.port=8787 \
    --label traefik.shiny.frontend.rule="Host:app.anpanman.co.kr" \
    --label traefik.rstudio.frontend.rule="Host:server.anpanman.co.kr" \
    -e USER=js -e PASSWORD=js -e ROOT=TRUE \
    --mount=type=bind,src=/home/js,dst=/home/js \
    --network traefik-net \
     jinseob2kim/docker-rshiny
```
https://server.anpanman.co.kr 에서 'rstudio server'를, https://app.anpanman.co.kr 에서 'shiny server'를 실행할 수 있다. 



# 서비스 추가: 홈페이지

proxy server 프로그램인 [nginx](https://www.nginx.com/)의 [docker image](https://hub.docker.com/_/nginx/) 를 이용하였고, [blogdown 패키지](https://github.com/rstudio/blogdown) 를 활용해서 홈페이지를 만들었다. 


```shell
docker service create \
    --name nginx \
    --label traefik.port=80 \
    --label traefik.frontend.rule="Host:${DOMAINNAME},www.${DOMAINNAME}" 
    --network traefik-net \
    nginx 
```
https://anpanman.co.kr, https://www.anpanman.co.kr 에서 [nginx](https://www.nginx.com/) 실행환경을 볼 수 있다. 


# 중간 정리 

1. 필요한 서비스를 미리 [Docker image](https://hub.docker.com/r/jinseob2kim/docker-rshiny/) 로 만들었다. 

2. [Docker-machine](https://docs.docker.com/machine/overview/) 을 이용하여 [Docker](https://www.docker.com/what-docker)가 설치된 클라우드 서버를 여러 개 생성한 후 

3. [Docker swarm](https://docs.docker.com/engine/swarm/) 을 통해 서버들을 묶었다. 

4. 이제 서비스를 실행하면 Swarm 환경이 알아서 적절한 서버를 골라 실행한다. 

5. [Traefik](https://traefik.io/) 을 이용하여 서비스를 추가할 때마다 그에 맞는 **subdomain** 주소를 자동으로 할당하였다. 

6. [Let's Encrypt](https://letsencrypt.org/) 을 통한 **https** 인증이 자동으로 적용된다. 



# 3. 의학연구용 `ShinyApps` 만들기 

# 주 활용 패키지 

- 데이터: `data.table`, `DT`, `labelled`

- 통계분석: `tableone`, `epiDisplay`, `survival`, `geepack`, `lme4`, `plotROC`, `pROC`

- Plot: `ggplot2`, `svglite`

- 패키지: `devtools`, `roxygen2`

- Shiny: `shinycustomloader` 


# Label

- 데이터의 변수명, 값 $\neq$ 테이블/그림의 변수명, 값 

```{r}
datatable(mtcars)
```


# Table 1: tableone package

![](https://github.com/kaz-yos/tableone/raw/master/tableone.gif)

[tableone](https://github.com/kaz-yos/tableone) package


# Examples 

1. [기본 앱 모음](https://app.anpanman.co.kr/navbar)

2. [건강설문조사 리포트](https://app.anpanman.co.kr/health-report)

3. [대장암 환자 연구: 강릉아산병원](https://app.anpanman.co.kr/yschoi)

4. [이완기 압력 계산: 삼성서울병원](https://app.anpanman.co.kr/chkh/dPR)





# {.bigger}

<center> [Anpanman](https://www.anpanman.co.kr/) 은 앞으로 맞춤형 의학연구 지원을 통해 의학연구 활성화를 이끌겠습니다. 감사합니다.</center> 


```{r, out.width= "50%"}
include_graphics("color_logo_transparent.png")
```






